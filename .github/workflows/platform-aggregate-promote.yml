name: Platform Aggregate & Promote

concurrency:
  group: platform-aggregate-promote
  cancel-in-progress: false

on:
  schedule:
    - cron: '0 9 */14 * 1'
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for manual platform aggregation'
        required: false
        default: 'Manual hotfix or testing'
        type: string
      create_version:
        description: "Create platform application version"
        required: false
        default: true
        type: boolean
      auto_promote:
        description: "Automatically promote through all stages to PROD"
        required: false
        default: true
        type: boolean
      preview_only:
        description: "Preview only (no writes)"
        required: false
        default: false
        type: boolean
      inventory_version:
        description: "Force inventory version (optional)"
        required: false
        type: string
      recommendations_version:
        description: "Force recommendations version (optional)"
        required: false
        type: string
      checkout_version:
        description: "Force checkout version (optional)"
        required: false
        type: string
      web_version:
        description: "Force web version (optional)"
        required: false
        type: string

jobs:
  aggregate:
    name: "Platform Aggregation"
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    outputs:
      platform_version: ${{ steps.create-version.outputs.platform_version }}
      manifest_created: ${{ steps.create-version.outputs.manifest_created }}
    defaults:
      run:
        shell: bash
    steps:
      - name: "[Setup] Checkout"
        uses: actions/checkout@v4

      - name: "[Setup] Checkout bookverse-infra for shared scripts"
        uses: actions/checkout@v4
        with:
          repository: 'tpaz1/bookverse-infra'
          ref: 'main'
          path: 'bookverse-infra'

      - name: "[Setup] Python Environment"
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: "[Setup] JFrog CLI"
        uses: EyalDelarea/setup-jfrog-cli@swampUpAppTrust
        id: jfrog-cli-auth
        with:
          oidc-provider-name: bookverse-platform-github
          oidc-audience: ${{ vars.JFROG_URL }}
        env:
          JF_URL: ${{ vars.JFROG_URL }}
          JF_PROJECT: ${{ vars.PROJECT_KEY }}

      - name: "[Setup] Install Python dependencies"
        run: |
          pip install --user PyYAML setuptools wheel
          echo "âœ… Python dependencies installed"

      - name: "[Run] Create version and write manifest"
        id: collect-versions
        env:
          JFROG_URL: "${{ vars.JFROG_URL }}"
          JF_OIDC_TOKEN: "${{ steps.jfrog-cli-auth.outputs.oidc-token }}"
        run: |
          set -euo pipefail
          ARGS="--config config/services.yaml --output-dir manifests --source-stage PROD"
          if [[ -n "${{ inputs.inventory_version }}" ]]; then ARGS="$ARGS --override inventory=${{ inputs.inventory_version }}"; fi
          if [[ -n "${{ inputs.recommendations_version }}" ]]; then ARGS="$ARGS --override recommendations=${{ inputs.recommendations_version }}"; fi
          if [[ -n "${{ inputs.checkout_version }}" ]]; then ARGS="$ARGS --override checkout=${{ inputs.checkout_version }}"; fi
          if [[ -n "${{ inputs.web_version }}" ]]; then ARGS="$ARGS --override web=${{ inputs.web_version }}"; fi
          python -m app.main $ARGS | tee release_output.txt

      - name: "[Extract] Platform version from output"
        id: create-version
        if: ${{ inputs.create_version != false && inputs.preview_only != true }}
        run: |
          set -euo pipefail
          PLATFORM_VERSION=$(grep -o '"platform_app_version": "[^"]*"' release_output.txt | sed 's/"platform_app_version": "//; s/"//' | head -1)
          if [[ -z "$PLATFORM_VERSION" ]]; then
            echo "âŒ Could not extract platform version from output"
            exit 1
          fi
          echo "platform_version=$PLATFORM_VERSION" >> $GITHUB_OUTPUT
          echo "manifest_created=true" >> $GITHUB_OUTPUT
          echo "âœ… Platform application version created: $PLATFORM_VERSION"


      - name: "[Summary] Aggregation"
        run: |
          echo "## ðŸ—ï¸ Platform Aggregation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Platform Version:** \`${{ steps.create-version.outputs.platform_version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow:** \`${{ github.workflow }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Details" >> $GITHUB_STEP_SUMMARY
          echo "- Platform aggregation completed successfully" >> $GITHUB_STEP_SUMMARY
          echo "- Service versions collected from PROD stage" >> $GITHUB_STEP_SUMMARY
          echo "- Platform manifest generated" >> $GITHUB_STEP_SUMMARY

  promote:
    name: "Auto-Promote Platform"
    needs: aggregate
    if: ${{ needs.aggregate.outputs.manifest_created == 'true' && inputs.auto_promote != false && inputs.preview_only != true }}
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    permissions:
      contents: read
      id-token: write
    env:
      JFROG_URL: ${{ vars.JFROG_URL }}
    steps:
      - name: "[Setup] Checkout"
        uses: actions/checkout@v4

      - name: "[Setup] Checkout bookverse-infra for shared promotion library"
        uses: actions/checkout@v4
        with:
          repository: 'tpaz1/bookverse-infra'
          ref: 'main'
          path: 'bookverse-infra'

      - name: "[Setup] Python"
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: "[Setup] Install Python dependencies"
        run: |
          pip install --user PyYAML setuptools wheel
          echo "âœ… Python dependencies installed"

      - name: "[Setup] JFrog CLI"
        uses: EyalDelarea/setup-jfrog-cli@swampUpAppTrust
        id: jfrog-cli-auth
        with:
          oidc-provider-name: bookverse-platform-github
          oidc-audience: ${{ vars.JFROG_URL }}
        env:
          JF_URL: ${{ vars.JFROG_URL }}
          JF_PROJECT: ${{ vars.PROJECT_KEY }}

      - name: "[Setup] Configure JFrog CLI"
        run: |
          jf c add --interactive=false --url "${{ vars.JFROG_URL }}" --access-token ""
          echo "âœ… JFrog CLI configured"

      - name: "[Setup] Promotion Environment"
        env:
          APPLICATION_KEY: "bookverse-platform"
          APP_VERSION: "${{ needs.aggregate.outputs.platform_version }}"
          JFROG_URL: "${{ vars.JFROG_URL }}"
          PROJECT_KEY: "${{ vars.PROJECT_KEY }}"
          JF_OIDC_TOKEN: "${{ steps.jfrog-cli-auth.outputs.oidc-token }}"
          STAGES_STR: "DEV QA STAGING"
          FINAL_STAGE: "STAGING"
          ALLOW_RELEASE: "false"
        run: |
          echo "ðŸš€ Initializing platform promotion environment..."
          echo "ðŸ“‹ Platform Version: ${{ needs.aggregate.outputs.platform_version }}"
          echo "ðŸŽ¯ Target: DEV â†’ QA â†’ STAGING (PROD handled by separate workflow)"
          
          source bookverse-infra/libraries/bookverse-devops/scripts/evidence-lib.sh
          setup_promotion_environment
          
          echo "âœ… Promotion environment initialized"

      - name: "[Promote & Evidence] DEV Stage"
        env:
          APPLICATION_KEY: "bookverse-platform"
          APP_VERSION: "${{ needs.aggregate.outputs.platform_version }}"
          JFROG_URL: "${{ vars.JFROG_URL }}"
          PROJECT_KEY: "${{ vars.PROJECT_KEY }}"
          JF_OIDC_TOKEN: "${{ steps.jfrog-cli-auth.outputs.oidc-token }}"
          STAGES_STR: "DEV QA STAGING"
          FINAL_STAGE: "STAGING"
          ALLOW_RELEASE: "false"
          EVIDENCE_PRIVATE_KEY: ${{ secrets.EVIDENCE_PRIVATE_KEY }}
          EVIDENCE_KEY_ALIAS: ${{ vars.EVIDENCE_KEY_ALIAS }}
          APPTRUST_TIMEOUT_SECONDS: 300
        run: |
          echo "ðŸ§ª Promoting platform to DEV stage with evidence collection"
          echo "ðŸ“‹ Platform Version: $APP_VERSION"
          echo "ðŸŽ¯ Target Stage: DEV (development environment for platform testing)"
          echo "ðŸ›¡ï¸ Evidence Type: Platform aggregation validation and smoke tests"
          
          if [[ -z "${JF_OIDC_TOKEN:-}" ]]; then
            echo "âŒ Missing JF_OIDC_TOKEN. Ensure OIDC exchange step succeeded." >&2
            exit 1
          fi
          echo "âœ… Using JF_OIDC_TOKEN for DEV promotion"
          
          source bookverse-infra/libraries/bookverse-devops/scripts/evidence-lib.sh
          setup_promotion_environment
          
          if advance_one_step; then
            echo "âœ… Successfully promoted platform to DEV"
          else
            echo "âŒ Failed to promote platform to DEV"
            exit 1
          fi
          
          # Attach platform-specific DEV evidence
          attach_application_dev_evidence
          echo "âœ… DEV stage evidence attached via shared library: platform-smoke-tests"

      - name: "[Promote & Evidence] QA Stage"
        env:
          APPLICATION_KEY: "bookverse-platform"
          APP_VERSION: "${{ needs.aggregate.outputs.platform_version }}"
          JFROG_URL: "${{ vars.JFROG_URL }}"
          PROJECT_KEY: "${{ vars.PROJECT_KEY }}"
          JF_OIDC_TOKEN: "${{ steps.jfrog-cli-auth.outputs.oidc-token }}"
          STAGES_STR: "DEV QA STAGING"
          FINAL_STAGE: "STAGING"
          ALLOW_RELEASE: "false"
          EVIDENCE_PRIVATE_KEY: ${{ secrets.EVIDENCE_PRIVATE_KEY }}
          EVIDENCE_KEY_ALIAS: ${{ vars.EVIDENCE_KEY_ALIAS }}
          APPTRUST_TIMEOUT_SECONDS: 300
        run: |
          echo "ðŸ” Promoting platform to QA stage with evidence collection"
          echo "ðŸ“‹ Platform Version: $APP_VERSION"
          echo "ðŸŽ¯ Target Stage: QA (quality assurance for platform integration)"
          echo "ðŸ›¡ï¸ Evidence Type: Platform integration tests and service compatibility validation"
          
          if [[ -z "${JF_OIDC_TOKEN:-}" ]]; then
            echo "âŒ Missing JF_OIDC_TOKEN. Ensure OIDC exchange step succeeded." >&2
            exit 1
          fi
          echo "âœ… Using JF_OIDC_TOKEN for QA promotion"
          
          source bookverse-infra/libraries/bookverse-devops/scripts/evidence-lib.sh
          setup_promotion_environment
          
          if advance_one_step; then
            echo "âœ… Successfully promoted platform to QA"
          else
            echo "âŒ Failed to promote platform to QA"
            exit 1
          fi
          
          # Attach platform-specific QA evidence
          attach_application_qa_evidence
          echo "âœ… QA stage evidence attached via shared library: platform-integration-tests, service-compatibility-scan"

      - name: "[Promote & Evidence] STAGING Stage"
        env:
          APPLICATION_KEY: "bookverse-platform"
          APP_VERSION: "${{ needs.aggregate.outputs.platform_version }}"
          JFROG_URL: "${{ vars.JFROG_URL }}"
          PROJECT_KEY: "${{ vars.PROJECT_KEY }}"
          JF_OIDC_TOKEN: "${{ steps.jfrog-cli-auth.outputs.oidc-token }}"
          STAGES_STR: "DEV QA STAGING"
          FINAL_STAGE: "STAGING"
          ALLOW_RELEASE: "false"
          EVIDENCE_PRIVATE_KEY: ${{ secrets.EVIDENCE_PRIVATE_KEY }}
          EVIDENCE_KEY_ALIAS: ${{ vars.EVIDENCE_KEY_ALIAS }}
          APPTRUST_TIMEOUT_SECONDS: 300
        run: |
          echo "ðŸ—ï¸ Promoting platform to STAGING stage with evidence collection"
          echo "ðŸ“‹ Platform Version: $APP_VERSION"
          echo "ðŸŽ¯ Target Stage: STAGING (pre-production platform validation)"
          echo "ðŸ›¡ï¸ Evidence Type: Platform performance tests and production readiness validation"
          
          if [[ -z "${JF_OIDC_TOKEN:-}" ]]; then
            echo "âŒ Missing JF_OIDC_TOKEN. Ensure OIDC exchange step succeeded." >&2
            exit 1
          fi
          echo "âœ… Using JF_OIDC_TOKEN for STAGING promotion"
          
          source bookverse-infra/libraries/bookverse-devops/scripts/evidence-lib.sh
          setup_promotion_environment
          
          if advance_one_step; then
            echo "âœ… Successfully promoted platform to STAGING"
          else
            echo "âŒ Failed to promote platform to STAGING"
            exit 1
          fi
          
          # Attach platform-specific STAGING evidence
          attach_application_staging_evidence
          echo "âœ… STAGING stage evidence attached via shared library: platform-performance-test, production-readiness-scan"
          echo "ðŸŽ‰ Platform version $APP_VERSION successfully promoted to STAGING with all evidence!"
          echo "ðŸ”„ Use separate release workflow to promote to PROD when ready"

      - name: "ðŸ“Š Enhanced Platform Summary (bookverse-devops pattern)"
        if: always()
        run: |
          echo "ðŸ“Š Generating comprehensive platform aggregation and promotion summary for stakeholder visibility"
          echo "ðŸŽ¯ This summary provides complete aggregation status, service versions, and deployment readiness"
          
          echo "## ðŸ—ï¸ BookVerse Platform - Aggregation & Promotion Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Platform Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Service:** platform (aggregation service)" >> $GITHUB_STEP_SUMMARY
          echo "- **Platform Version:** \`${{ needs.aggregate.outputs.platform_version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Workflow Type:** Aggregation & Auto-Promotion" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### âœ… AppTrust Compliance Status" >> $GITHUB_STEP_SUMMARY
          echo "- **Job 1 (aggregate):** âœ… Completed - Service versions collected and platform version created" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ needs.aggregate.outputs.manifest_created }}" == "true" ]]; then
            echo "- **Job 2 (promote):** âœ… Completed - Platform promoted through all stages to STAGING" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Job 2 (promote):** â­ï¸ Skipped (preview mode or creation disabled)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ”— Aggregated Service Versions" >> $GITHUB_STEP_SUMMARY
          echo "Platform aggregates the following service application versions from PROD stage:" >> $GITHUB_STEP_SUMMARY
          echo "- **ðŸ“¦ Inventory Service:** \`${{ inputs.inventory_version || 'Latest from PROD' }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **ðŸŽ¯ Recommendations Service:** \`${{ inputs.recommendations_version || 'Latest from PROD' }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **ðŸ’³ Checkout Service:** \`${{ inputs.checkout_version || 'Latest from PROD' }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **ðŸŒ Web Service:** \`${{ inputs.web_version || 'Latest from PROD' }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **ðŸ“‹ Platform Manifest:** âœ… Generated with service dependencies" >> $GITHUB_STEP_SUMMARY
          echo "- **ðŸ”— Platform Application Version:** âœ… Created in AppTrust with source links" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.aggregate.outputs.manifest_created }}" == "true" ]]; then
            echo "### ðŸŽ¯ Promotion Path & Evidence" >> $GITHUB_STEP_SUMMARY
            echo "Platform follows step-by-step promotion with comprehensive evidence collection:" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… **UNASSIGNED â†’ DEV**: Platform aggregation validation and smoke tests" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… **DEV â†’ QA**: Integration tests and service compatibility validation" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… **QA â†’ STAGING**: Performance tests and production readiness validation" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            echo "### ðŸ›¡ï¸ Evidence Artifacts" >> $GITHUB_STEP_SUMMARY
            echo "- **DEV Evidence:** platform-smoke-tests" >> $GITHUB_STEP_SUMMARY
            echo "- **QA Evidence:** platform-integration-tests, service-compatibility-scan" >> $GITHUB_STEP_SUMMARY
            echo "- **STAGING Evidence:** platform-performance-test, production-readiness-scan" >> $GITHUB_STEP_SUMMARY
            echo "- **Evidence Collection:** âœ… Cryptographically signed and uploaded" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "### ðŸš€ Platform Optimizations Applied" >> $GITHUB_STEP_SUMMARY
          echo "- **bookverse-devops:** âœ… Shared OIDC authentication & promotion patterns" >> $GITHUB_STEP_SUMMARY
          echo "- **Service Aggregation:** âœ… Automated collection from PROD stage releases" >> $GITHUB_STEP_SUMMARY
          echo "- **Step-by-step Promotion:** âœ… Individual stage promotion with evidence" >> $GITHUB_STEP_SUMMARY
          echo "- **Compliance Evidence:** âœ… Comprehensive audit trail for each stage" >> $GITHUB_STEP_SUMMARY
          echo "- **Platform-specific Logic:** âœ… Custom aggregation without package versioning" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.aggregate.outputs.manifest_created }}" == "true" ]]; then
            echo "### ðŸŽ¯ Platform Deployment Status" >> $GITHUB_STEP_SUMMARY
            echo "Platform version **\`${{ needs.aggregate.outputs.platform_version }}\`** has been created and promoted to **STAGING**." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**ðŸ”„ Next Steps:**" >> $GITHUB_STEP_SUMMARY
            echo "- Platform is ready for STAGING validation and testing" >> $GITHUB_STEP_SUMMARY
            echo "- Use separate **Release** workflow to promote to PROD when ready" >> $GITHUB_STEP_SUMMARY
            echo "- PROD promotion requires manual approval and additional compliance validation" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ðŸ“‹ Preview Mode" >> $GITHUB_STEP_SUMMARY
            echo "Platform aggregation ran in preview mode - no versions created or promoted." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**ðŸ”„ Next Steps:**" >> $GITHUB_STEP_SUMMARY
            echo "- Run workflow with \`create_version=true\` to create platform application version" >> $GITHUB_STEP_SUMMARY
            echo "- Ensure \`auto_promote=true\` to enable automatic promotion to STAGING" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Enhanced platform summary generated using bookverse-devops patterns" >> $GITHUB_STEP_SUMMARY
